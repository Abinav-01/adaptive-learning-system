<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Smart Attention Monitor â€” Demo</title>
    <link rel="icon" href="/static/favicon.ico">
    <style>
        :root{
            --bg:#f5f7fb;
            --card:#ffffff;
            --primary:#2563eb;
            --muted:#6b7280;
            --success:#10b981;
            --danger:#ef4444;
            --glass: rgba(255,255,255,0.6);
            font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
        }
        html,body{height:100%;margin:0;background:linear-gradient(180deg,#eef2ff 0%,var(--bg) 100%);}
        .topbar{display:flex;align-items:center;justify-content:space-between;padding:14px 24px;background:var(--card);box-shadow:0 2px 8px rgba(16,24,40,0.05);}
        .brand{display:flex;gap:12px;align-items:center}
        .logo{width:40px;height:40px;border-radius:8px;background:linear-gradient(135deg,var(--primary),#7c3aed);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
        .title{font-size:18px;font-weight:700}
        .nav{display:flex;gap:12px;align-items:center}
        .btn{background:var(--primary);color:#fff;padding:8px 12px;border-radius:8px;text-decoration:none;font-weight:600}

        .container{max-width:1100px;margin:28px auto;padding:20px;display:grid;grid-template-columns:1fr 380px;gap:20px}
        .card{background:var(--card);border-radius:12px;padding:18px;box-shadow:0 6px 18px rgba(16,24,40,0.06)}
        .video-wrap{display:flex;flex-direction:column;align-items:center;gap:12px}
        video{border-radius:10px;width:100%;max-width:720px;box-shadow:0 8px 20px rgba(2,6,23,0.08)}
        #status{font-weight:700;font-size:16px}

        .info h3{margin:0 0 8px 0}
        .progress{height:12px;background:#eef2ff;border-radius:8px;overflow:hidden}
        .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--primary),#7c3aed);width:40%}
        .controls{display:flex;gap:8px;margin-top:12px}
        .muted{color:var(--muted);font-size:14px}

        @media (max-width:900px){
            .container{grid-template-columns:1fr;padding:12px}
            .nav{display:none}
        }
    </style>
</head>
<body>

<div class="topbar">
    <div class="brand">
        <div class="logo">AL</div>
        <div>
            <div class="title">Adaptive Learning â€” Demo</div>
            <div class="muted">Attention monitoring & adaptive UI</div>
        </div>
    </div>
    <div class="nav">
        <a class="btn" href="#">Start Session</a>
        <a href="#" style="color:var(--muted);text-decoration:none">Docs</a>
        <a href="#" style="color:var(--muted);text-decoration:none">About</a>
    </div>
</div>

<main class="container">
    <section class="card video-wrap">
        <div style="width:100%;display:flex;justify-content:space-between;align-items:center">
            <div style="display:flex;flex-direction:column">
                <strong>Live Camera</strong>
                <span class="muted">Your webcam will be used for attention detection (demo only)</span>
            </div>
            <div id="status" style="color:green">Status: Detecting...</div>
        </div>

        <video id="video" autoplay playsinline></video>

        <div style="width:100%;display:flex;justify-content:center;margin-top:6px">
            <button class="btn" id="allowBtn">Allow Camera</button>
            <button style="margin-left:8px;padding:8px 12px;border-radius:8px;border:1px solid #e6e9ef;background:transparent;">Pause</button>
        </div>
    </section>

    <aside class="card info">
        <h3>Session Summary</h3>
        <p class="muted">This demo shows live attention detection using web camera landmarks. No video is stored.</p>

        <div style="margin-top:12px">
            <div style="display:flex;justify-content:space-between"><small class="muted">Focus Score</small><strong id="focusScore">--%</strong></div>
            <div class="progress" style="margin-top:8px"><i id="progressBar"></i></div>
        </div>

        <div style="margin-top:18px">
            <h4 style="margin:0 0 8px 0">Actions</h4>
            <div class="controls">
                <button class="btn">Give Hint</button>
                <button style="padding:8px 12px;border-radius:8px;border:1px solid #e6e9ef;background:transparent;">Start Quiz</button>
            </div>
        </div>

        <div style="margin-top:18px">
            <h4 style="margin:0 0 8px 0">Notes</h4>
            <p class="muted">This page is a minimal one-page demo for development. Connect it to backend APIs to store session metrics.</p>
        </div>
    </aside>
</main>

<!-- Mediapipe -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script>
const video = document.getElementById('video');
const statusEl = document.getElementById('status');
const focusScore = document.getElementById('focusScore');
const progressBar = document.getElementById('progressBar');

let inattentiveCounter = 0;
const CHECK_INTERVAL = 5000; // check every 5 seconds
const MAX_INATTENTIVE_COUNT = 3; // alert after 3 consecutive inattentive checks (~15 sec)

// Initialize Mediapipe FaceMesh
const faceMesh = new FaceMesh({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}` });
faceMesh.setOptions({
  maxNumFaces: 1,
  refineLandmarks: true,
  minDetectionConfidence: 0.5,
  minTrackingConfidence: 0.5
});

function computeAttention(landmarks) {
  try{
    const leftEye = landmarks[33];
    const rightEye = landmarks[263];
    const noseTip = landmarks[1];
    const eyeDistance = Math.hypot(leftEye.x - rightEye.x, leftEye.y - rightEye.y);
    const noseToEyeY = Math.abs(noseTip.y - (leftEye.y + rightEye.y)/2);
    const headFacing = (noseToEyeY / eyeDistance) < 0.4;

    const leftEAR = Math.abs(landmarks[159].y - landmarks[145].y);
    const rightEAR = Math.abs(landmarks[386].y - landmarks[374].y);
    const eyesOpen = leftEAR > 0.015 && rightEAR > 0.015;

    return headFacing && eyesOpen;
  } catch(e){
    return false;
  }
}

faceMesh.onResults(results => {
  if (!results.multiFaceLandmarks || results.multiFaceLandmarks.length === 0) {
    inattentiveCounter++;
  } else {
    const attentive = computeAttention(results.multiFaceLandmarks[0]);
    inattentiveCounter = attentive ? 0 : inattentiveCounter + 1;
  }

  let score = Math.max(0, 100 - inattentiveCounter * 20);
  focusScore.innerText = score + "%";
  progressBar.style.width = score + "%";

  if (inattentiveCounter >= MAX_INATTENTIVE_COUNT) {
    statusEl.innerText = "Status: Please focus on the class!";
    statusEl.style.color = "var(--danger)";
  } else {
    statusEl.innerText = "Status: Attentive ðŸ™‚";
    statusEl.style.color = "var(--success)";
  }
});

// Start camera when user clicks allow (explicit UX)
const allowBtn = document.getElementById('allowBtn');
let camera;
allowBtn.addEventListener('click', async () => {
  allowBtn.disabled = true;
  allowBtn.innerText = 'Starting...';
  try{
    camera = new Camera(video, {
      onFrame: async () => { await faceMesh.send({image: video}); },
      width: 720,
      height: 560
    });
    camera.start();
    allowBtn.innerText = 'Camera On';
  } catch(err){
    allowBtn.innerText = 'Permission required';
    allowBtn.disabled = false;
    console.error(err);
  }
});

// If user opened page with camera already allowed, attempt auto-start
setTimeout(() => {
  // allowBtn.click(); // commented to avoid auto-permission prompts
}, 700);

</script>

</body>
</html>
